version: '3.8'

services:
  postgres:
    image: postgres:17
    container_name: hasura-postgres
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgrespassword
      POSTGRES_DB: hasura_demo
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  hasura:
    build:
      context: ./hasura
      dockerfile: ./Dockerfile.dev
    container_name: hasura-graphql-engine
    volumes:
      - ./hasura/migrations:/hasura/migrations
      - ./hasura/metadata:/hasura/metadata
    ports:
      - "8080:8080"
      - "9693:9693"
      - "9695:9695"
    restart: always
    environment:
      ## PostgreSQL database URL
      HASURA_GRAPHQL_DATABASE_URL: postgres://postgres:postgrespassword@postgres:5432/hasura_demo
      HASURA_GRAPHQL_METADATA_DATABASE_URL: postgres://postgres:postgrespassword@postgres:5432/hasura_demo
      ## Enable the Hasura Console
      HASURA_GRAPHQL_ENABLE_CONSOLE: "true"
      ## Dev mode for detailed errors
      HASURA_GRAPHQL_DEV_MODE: "true"
      HASURA_GRAPHQL_SERVER_PORT: 8080
      ## Admin secret for securing the endpoint
      HASURA_GRAPHQL_ADMIN_SECRET: hasura-admin-secret
      HASURA_GRAPHQL_MIGRATIONS_DIR: /migrations
      HASURA_GRAPHQL_METADATA_DIR: /metadata
      ## Enable metadata API
      HASURA_GRAPHQL_ENABLED_APIS: metadata,graphql,config,pgdump
      ## Log level
      HASURA_GRAPHQL_LOG_LEVEL: info
      ## Enable telemetry (set to false for privacy)
      HASURA_GRAPHQL_ENABLE_TELEMETRY: "false"
      ## Experimental features
      HASURA_GRAPHQL_EXPERIMENTAL_FEATURES: naming_convention
      ## JWT configuration (example - uncomment and configure for production)
      # HASURA_GRAPHQL_JWT_SECRET: '{"type":"HS256", "key": "your-secret-key-min-32-chars-long!!"}'
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Jupyter notebook for the demo slideshow
  jupyter:
    image: jupyter/scipy-notebook:latest
    container_name: hasura-jupyter
    ports:
      - "8888:8888"
    environment:
      JUPYTER_ENABLE_LAB: "yes"
      JUPYTER_TOKEN: "hasura-demo"
    volumes:
      - ./notebooks:/home/jovyan/work
    depends_on:
      - hasura

volumes:
  postgres_data:
